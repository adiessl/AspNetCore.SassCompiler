<Project>

  <PropertyGroup>
    <IsOuterBuild Condition="'$(IsOuterBuild)' == ''">false</IsOuterBuild>

    <CompileSassBeforeTargets>Build;ResolveScopedCssInputs;BundleMinify;ResolveProjectStaticWebAssets</CompileSassBeforeTargets>
    <!-- Use DispatchToInnerBuilds if it is a multi-targeted build -->
    <CompileSassBeforeTargets Condition="$(IsOuterBuild)">DispatchToInnerBuilds</CompileSassBeforeTargets>

    <ShouldRunTarget>false</ShouldRunTarget>
    <!-- to prevent targets from being run extra times, enforce that only the outer
         build of a multi-targeted project or a single-targeted build can run -->
    <ShouldRunTarget Condition="'$(TargetFrameworks)' == '' OR $(IsOuterBuild)">true</ShouldRunTarget>
  </PropertyGroup>

  <PropertyGroup Condition="'$(SassCompilerIncludeRuntime)' == 'true'">
    <SassCompilerEnableWatcher>$(SassCompilerIncludeRuntime)</SassCompilerEnableWatcher>
    <SassCompilerRuntimeCopyToPublishDirectory>PreserveNewest</SassCompilerRuntimeCopyToPublishDirectory>
  </PropertyGroup>

  <ItemGroup>
    <UpToDateCheckInput Include="**/*.scss" />
  </ItemGroup>

  <UsingTask TaskName="AspNetCore.SassCompiler.CompileSass"
             AssemblyFile="$(SassCompilerTasksAssembly)" />

  <Target Name="Compile Sass" BeforeTargets="$(CompileSassBeforeTargets)" Condition="$(ShouldRunTarget) AND '$(DesignTimeBuild)' != 'true'">
    <CompileSass AppsettingsFile="$(SassCompilerAppsettingsJson)"
                 SassCompilerFile="$(SassCompilerSassCompilerJson)"
                 Command="$(SassCompilerBuildCommand)"
                 Snapshot="$(SassCompilerBuildSnapshot)"
                 Configuration="$(SassCompilerConfiguration)">
      <Output TaskParameter="GeneratedFiles"
              ItemName="CompiledCssFiles" />
    </CompileSass>

    <ItemGroup>
      <None Remove="@(CompiledCssFiles)" />

      <!-- Fix to only include files that were newly generated as to not have duplicate Content items. -->
      <_NewCompiledCssFiles Include="@(CompiledCssFiles)" Exclude="@(Content)" />
      <Content Include="@(_NewCompiledCssFiles)" />
    </ItemGroup>
  </Target>

</Project>
